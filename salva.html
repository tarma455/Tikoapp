<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIKO - Salva</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --p: #1e3a8a; --s: #2563eb; --bg: #f8fafc; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        
        /* Contenedores de Pantalla */
        .screen { display: none; padding: 20px; max-width: 450px; margin: auto; animation: fadeIn 0.3s ease; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Estilos de Tarjetas e Inputs */
        .card { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        h2 { color: var(--p); text-align: center; font-weight: 800; margin-bottom: 25px; }
        input { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #edf2f7; border-radius: 12px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: var(--s); outline: none; }
        
        /* Botones Estilizados */
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; background: var(--p); color: white; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; box-shadow: 0 4px 6px rgba(30, 58, 138, 0.2); }
        button:active { transform: translateY(2px); box-shadow: none; }
        .btn-sec { background: var(--s); }
        .btn-pdf { background: #10b981; margin-top: 20px; }
        .btn-back { background: #94a3b8; margin-top: 15px; }

        /* Estilos del PDF / Cartilla */
        #pdf-area { background: white; padding: 0; border-radius: 10px; color: #1a202c; }
        .pdf-header { text-align: center; border-bottom: 4px solid var(--p); padding-bottom: 15px; margin-bottom: 20px; }
        .pdf-section-title { background: #f1f5f9; padding: 10px; border-left: 5px solid var(--p); font-weight: bold; margin-top: 20px; color: var(--p); text-transform: uppercase; font-size: 14px; }
        .pdf-row { display: flex; justify-content: space-between; padding: 12px 10px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .pdf-row span:last-child { color: #64748b; font-weight: bold; }
        .pet-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }

        .nav-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    </style>
</head>
<body>

    <div id="scr-login" class="screen active">
        <h2>üêæ TIKO LOGIN</h2>
        <div class="card">
            <p style="text-align: center; color: #64748b;">Ingresa tu nombre para comenzar</p>
            <input type="text" id="login-user" placeholder="Ej: Juan Perez">
            <button onclick="login()">ENTRAR A MI CUENTA</button>
        </div>
    </div>

    <div id="scr-home" class="screen">
        <h2 style="text-align: left;">¬°Hola, <span id="display-name" style="color: var(--s);"></span>! üëã</h2>
        <div class="nav-grid">
            <button onclick="show('scr-mascota')">üê∂ MI PERRO</button>
            <button onclick="show('scr-vacunas')">üíâ VACUNAS</button>
            <button onclick="show('scr-historial')">ü©∫ HISTORIAL</button>
            <button class="btn-sec" onclick="renderCartilla()">üìã VER CARTILLA</button>
        </div>
        <button class="btn-back" onclick="location.reload()">Cerrar Sesi√≥n</button>
    </div>

    <div id="scr-mascota" class="screen">
        <h2>Datos de la Mascota</h2>
        <div class="card">
            <input type="text" id="m-nom" placeholder="Nombre de la Mascota">
            <input type="text" id="m-esp" placeholder="Raza o Especie">
            <input type="number" id="m-edad" placeholder="Edad (a√±os)">
            <button onclick="saveMascota()">GUARDAR INFORMACI√ìN</button>
        </div>
        <button class="btn-back" onclick="show('scr-home')">Volver</button>
    </div>

    <div id="scr-vacunas" class="screen">
        <h2>Registro de Vacunas</h2>
        <div class="card">
            <input type="text" id="v-nom" placeholder="Nombre de la Vacuna">
            <input type="date" id="v-fec">
            <button onclick="addVacuna()">AGREGAR VACUNA</button>
            <div id="list-v" style="margin-top:20px; max-height: 200px; overflow-y: auto;"></div>
        </div>
        <button class="btn-back" onclick="show('scr-home')">Volver</button>
    </div>

    <div id="scr-historial" class="screen">
        <h2>Enfermedades / Historial</h2>
        <div class="card">
            <input type="text" id="h-enf" placeholder="Enfermedad o Diagn√≥stico">
            <input type="date" id="h-fec">
            <button onclick="addHistorial()">REGISTRAR EVENTO</button>
            <div id="list-h" style="margin-top:20px; max-height: 200px; overflow-y: auto;"></div>
        </div>
        <button class="btn-back" onclick="show('scr-home')">Volver</button>
    </div>

    <div id="scr-cartilla" class="screen" style="max-width: 600px;">
        <div id="pdf-area">
            <div class="pdf-header">
                <h1 style="margin:0; color: #1e3a8a;">CARTILLA VETERINARIA</h1>
                <p style="margin:5px 0; color: #64748b; font-size: 12px;">Generado por TIKO App - Salud Animal</p>
            </div>
            
            <div class="pdf-section-title">Informaci√≥n General</div>
            <div id="c-mascota" style="padding: 10px;"></div>
            
            <div class="pdf-section-title">Esquema de Vacunaci√≥n</div>
            <div id="c-vacunas"></div>

            <div class="pdf-section-title">Historial Cl√≠nico</div>
            <div id="c-historial"></div>
            
            <div style="margin-top: 30px; text-align: center; font-size: 10px; color: #cbd5e1;">
                Esta cartilla es un registro digital oficial del usuario.
            </div>
        </div>
        
        <button class="btn-pdf" onclick="downloadPDF()">üì© DESCARGAR PDF PROFESIONAL</button>
        <button class="btn-back" onclick="show('scr-home')">Volver al Inicio</button>
    </div>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyANX656iqyz6NIo7WX_IvIMnY4w9SQP6sU",
            authDomain: "tiko-ap.firebaseapp.com",
            projectId: "tiko-ap",
            databaseURL: "https://tiko-ap-default-rtdb.firebaseio.com/", 
            appId: "1:97455117291:web:1dc88f792d0a74c394bfae"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentUser = "";

        function show(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'scr-vacunas') loadList('vacunas', 'list-v');
            if(id === 'scr-historial') loadList('historial', 'list-h');
        }

        function login() {
            currentUser = document.getElementById('login-user').value.trim().replace(/\s+/g, '_');
            if(!currentUser) return alert("Ingresa tu nombre");
            document.getElementById('display-name').innerText = currentUser.replace('_', ' ');
            show('scr-home');
        }

        function saveMascota() {
            const data = {
                nombre: document.getElementById('m-nom').value,
                especie: document.getElementById('m-esp').value,
                edad: document.getElementById('m-edad').value
            };
            db.ref(currentUser + '/mascota').set(data).then(() => alert("¬°Datos actualizados!"));
        }

        function addVacuna() {
            const v = { nom: document.getElementById('v-nom').value, fec: document.getElementById('v-fec').value };
            if(!v.nom || !v.fec) return alert("Completa los campos");
            db.ref(currentUser + '/vacunas').push(v).then(() => {
                document.getElementById('v-nom').value = '';
                loadList('vacunas', 'list-v');
            });
        }

        function addHistorial() {
            const h = { enf: document.getElementById('h-enf').value, fec: document.getElementById('h-fec').value };
            if(!h.enf || !h.fec) return alert("Completa los campos");
            db.ref(currentUser + '/historial').push(h).then(() => {
                document.getElementById('h-enf').value = '';
                loadList('historial', 'list-h');
            });
        }

        function loadList(path, divId) {
            db.ref(currentUser + '/' + path).once('value', (snap) => {
                let html = '';
                snap.forEach(child => {
                    const d = child.val();
                    html += `<div class="pdf-row"><span>${d.nom || d.enf}</span> <span>${d.fec}</span></div>`;
                });
                document.getElementById(divId).innerHTML = html || '<p style="font-size:12px; color:gray">No hay registros a√∫n.</p>';
            });
        }

        function renderCartilla() {
            db.ref(currentUser).once('value', (snap) => {
                const data = snap.val() || {};
                const m = data.mascota || {nombre: 'No registrado', especie: '---', edad: '---'};
                
                document.getElementById('c-mascota').innerHTML = `
                    <div class="pet-info-grid">
                        <div><strong>Due√±o:</strong><br>${currentUser.replace('_', ' ')}</div>
                        <div><strong>Mascota:</strong><br>${m.nombre}</div>
                        <div><strong>Especie:</strong><br>${m.especie}</div>
                        <div><strong>Edad:</strong><br>${m.edad} a√±os</div>
                    </div>
                `;
                
                let vHtml = '';
                if(data.vacunas) Object.values(data.vacunas).forEach(v => {
                    vHtml += `<div class="pdf-row"><span>üíâ ${v.nom}</span> <span>${v.fec}</span></div>`;
                });
                document.getElementById('c-vacunas').innerHTML = vHtml || '<div class="pdf-row">Sin vacunas registradas</div>';

                let hHtml = '';
                if(data.historial) Object.values(data.historial).forEach(h => {
                    hHtml += `<div class="pdf-row"><span>ü©∫ ${h.enf}</span> <span>${h.fec}</span></div>`;
                });
                document.getElementById('c-historial').innerHTML = hHtml || '<div class="pdf-row">Sin historial m√©dico</div>';
                
                show('scr-cartilla');
            });
        }

        function downloadPDF() {
            const element = document.getElementById('pdf-area');
            const opt = {
                margin: 10,
                filename: `TIKO_Cartilla_${currentUser}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
