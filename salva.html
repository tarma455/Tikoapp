<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TIKO - salva.html (PDF mejorado + QR + MIT friendly)</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<!-- html2pdf (genera el PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- qrcode.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
:root{--p:#1e3a8a;--s:#2563eb;--bg:#f8fafc}
body{font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);margin:0;padding:20px}
.screen{display:none;max-width:740px;margin:18px auto}
.screen.active{display:block}
.card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
h2{text-align:center;color:var(--p)}
input{width:100%;padding:10px;margin:8px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box}
button{width:100%;padding:12px;border:none;border-radius:8px;background:var(--p);color:#fff;font-weight:700;cursor:pointer;margin-top:8px}
.btn-sec{background:var(--s)}
.btn-back{background:#94a3b8}
.item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee}
.solo-lectura .btn-back,.solo-lectura #btn-pdf-descarga{display:none!important}
.small{font-size:13px;color:#444}
.qr-wrap{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.qr-box{background:white;padding:12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
.qr-link{word-break:break-all;color:#0b61d6}

/* --- Estilos para PDF (no afectan la UI normal) --- */
#pdf-area {
  background: white;
  box-sizing: border-box;
  padding: 12mm; /* margen interior para la vista normal */
  overflow: visible !important;
  width: auto; /* ancho en pantalla; se usar치 CSS de p치gina al generar pdf */
}

/* Evitar cortar items dentro de una p치gina */
.item {
  break-inside: avoid;
  page-break-inside: avoid;
  -webkit-column-break-inside: avoid;
}

/* P치ginas que generaremos din치micamente */
.pdf-page {
  width: 210mm;        /* A4 */
  height: 297mm;       /* A4 */
  box-sizing: border-box;
  background: white;
  overflow: hidden;
  padding: 12mm;       /* margen interior de p치gina */
  page-break-after: always;
}

.pdf-page .page-content {
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  overflow: hidden;
}

.pdf-page .item {
  break-inside: avoid;
  page-break-inside: avoid;
  -webkit-column-break-inside: avoid;
}
</style>
</head>
<body id="main-body">

<!-- LOGIN -->
<div id="scr-login" class="screen active">
  <div class="card">
    <h2>游 TIKO LOGIN</h2>
    <input id="login-user" placeholder="Usuario (ej. juan_perez)">
    <button type="button" onclick="login()">Entrar</button>
  </div>
</div>

<!-- HOME -->
<div id="scr-home" class="screen">
  <div class="card">
    <h2>Panel de Control</h2>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <button type="button" onclick="show('scr-mascota')">游냤 Mascota</button>
      <button type="button" onclick="show('scr-vacunas')">游눌 Vacunas</button>
      <button type="button" onclick="show('scr-historial')">游뽘 Historial</button>
      <button type="button" class="btn-sec" onclick="show('scr-qr')">游댭 Generar QR</button>
      <button type="button" class="btn-sec" onclick="renderCartilla()">游늶 Ver Cartilla</button>
    </div>
    <button type="button" class="btn-back" onclick="location.reload()">Salir</button>
  </div>
</div>

<!-- MASCOTA -->
<div id="scr-mascota" class="screen">
  <div class="card">
    <h2>Datos Mascota</h2>
    <input id="m-nom" placeholder="Nombre">
    <input id="m-esp" placeholder="Especie">
    <input id="m-edad" type="number" placeholder="Edad">
    <button type="button" onclick="saveMascota()">Guardar</button>
    <button type="button" class="btn-back" onclick="show('scr-home')">Volver</button>
  </div>
</div>

<!-- VACUNAS -->
<div id="scr-vacunas" class="screen">
  <div class="card">
    <h2>Vacunas</h2>
    <input id="v-nom" placeholder="Vacuna">
    <input id="v-fec" type="date">
    <button type="button" onclick="addVacuna()">A침adir</button>
    <div id="list-v"></div>
    <button type="button" class="btn-back" onclick="show('scr-home')">Volver</button>
  </div>
</div>

<!-- HISTORIAL -->
<div id="scr-historial" class="screen">
  <div class="card">
    <h2>Enfermedades</h2>
    <input id="h-enf" placeholder="Enfermedad">
    <input id="h-fec" type="date">
    <button type="button" onclick="addHistorial()">A침adir</button>
    <div id="list-h"></div>
    <button type="button" class="btn-back" onclick="show('scr-home')">Volver</button>
  </div>
</div>

<!-- CARTILLA (contenido que se convertir치 a PDF) -->
<div id="scr-cartilla" class="screen">
  <div class="card" id="pdf-area">
    <h2>CARTILLA TIKO</h2>
    <div id="c-mascota" style="margin:10px 0"></div>
    <h3>游눌 Vacunaci칩n</h3>
    <div id="c-vacunas"></div>
    <h3>游뽘 Historial</h3>
    <div id="c-historial"></div>
  </div>

  <button type="button" id="btn-pdf-descarga" class="btn-sec" onclick="downloadPDF()">游늯 Descargar / Enviar a App</button>
  <button type="button" class="btn-back" onclick="show('scr-home')">Volver</button>
</div>

<!-- QR -->
<div id="scr-qr" class="screen">
  <div class="card">
    <h2>Generar QR - Cartilla</h2>

    <div class="small">Generar QR para el usuario actual:</div>
    <div style="display:flex;gap:8px;margin-top:6px">
      <button type="button" onclick="generateQRForCurrentUser()">Generar QR para usuario actual</button>
      <button type="button" class="btn-back" onclick="show('scr-home')">Volver</button>
    </div>

    <hr style="margin:12px 0">

    <div class="small">O ingresa un usuario manualmente (ej. juan_perez) y genera el QR:</div>
    <input id="qr-user-input" placeholder="usuario_ejemplo">
    <button type="button" class="btn-sec" onclick="generateQRManual()">Generar QR</button>

    <div style="margin-top:14px" class="qr-wrap">
      <div id="qr-container" class="qr-box"></div>
      <div style="flex:1">
        <div class="small">URL generada:</div>
        <div id="qr-url" class="qr-link"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button type="button" onclick="downloadQR()" id="btn-download-qr">游닌 Descargar QR</button>
          <button type="button" onclick="openQRInNewTab()">游댌 Abrir enlace en nueva pesta침a</button>
        </div>
      </div>
    </div>
    <p class="small" style="margin-top:10px;color:#666">
      Nota: Para que otros dispositivos vean la cartilla, la URL del QR debe ser accesible p칰blicamente (hostea este archivo).
    </p>
  </div>
</div>

<script>
/* =========== FIREBASE =========== */
firebase.initializeApp({
  apiKey: "AIzaSyANX656iqyz6NIo7WX_IvIMnY4w9SQP6sU",
  databaseURL: "https://tiko-ap-default-rtdb.firebaseio.com/",
  projectId: "tiko-ap",
  appId: "1:97455117291:web:1dc88f792d0a74c394bfae"
});
const db = firebase.database();
let currentUser = "";

/* =========== ONLOAD (modo ver por QR) =========== */
window.onload = function() {
  const p = new URLSearchParams(location.search);
  const modo = p.get('modo');
  const userQR = p.get('user');
  if (modo === 'ver' && userQR) {
    currentUser = userQR;
    document.getElementById('main-body').classList.add('solo-lectura');
    renderCartilla();
  }
};

/* =========== UI helpers =========== */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
  if (id === 'scr-vacunas') loadList('vacunas','list-v');
  if (id === 'scr-historial') loadList('historial','list-h');
}

/* =========== LOGIN simple =========== */
function login(){
  const raw = document.getElementById('login-user').value.trim();
  if (!raw) { alert('Escribe un usuario'); return; }
  currentUser = raw.replace(/\s+/g,'_');
  show('scr-home');
}

/* =========== DB functions =========== */
function saveMascota(){
  if(!currentUser){ alert('Inicia sesi칩n primero'); return; }
  const nombre = document.getElementById('m-nom').value;
  const especie = document.getElementById('m-esp').value;
  const edad = document.getElementById('m-edad').value;
  db.ref(currentUser + '/mascota').set({ nombre, especie, edad })
    .then(()=> alert('Mascota guardada'))
    .catch(err=> alert('Error guardando mascota: ' + err.message));
}

function addVacuna(){
  if(!currentUser){ alert('Inicia sesi칩n primero'); return; }
  const nom = document.getElementById('v-nom').value;
  const fec = document.getElementById('v-fec').value;
  if(!nom || !fec){ alert('Llena ambos campos'); return; }
  db.ref(currentUser + '/vacunas').push({ nom, fec })
    .then(()=> { document.getElementById('v-nom').value=''; document.getElementById('v-fec').value=''; loadList('vacunas','list-v'); })
    .catch(err=> alert('Error a침adiendo vacuna: ' + err.message));
}

function addHistorial(){
  if(!currentUser){ alert('Inicia sesi칩n primero'); return; }
  const enf = document.getElementById('h-enf').value;
  const fec = document.getElementById('h-fec').value;
  if(!enf || !fec){ alert('Llena ambos campos'); return; }
  db.ref(currentUser + '/historial').push({ enf, fec })
    .then(()=> { document.getElementById('h-enf').value=''; document.getElementById('h-fec').value=''; loadList('historial','list-h'); })
    .catch(err=> alert('Error a침adiendo historial: ' + err.message));
}

function loadList(path, divId){
  if(!currentUser) return;
  db.ref(currentUser + '/' + path).once('value')
    .then(snap=>{
      let html = '';
      snap.forEach(child=>{
        const d = child.val();
        html += `<div class="item"><span>${d.nom||d.enf}</span><span>${d.fec||''}</span></div>`;
      });
      document.getElementById(divId).innerHTML = html || '<div style="padding:8px;color:#666">Sin registros</div>';
    }).catch(err=> console.error('loadList error',err));
}

function renderCartilla(){
  if(!currentUser){ alert('Usuario no definido'); return; }
  db.ref(currentUser).once('value')
    .then(snap=>{
      const data = snap.val() || {};
      const m = data.mascota || {};
      document.getElementById('c-mascota').innerHTML =
        `<b>Usuario:</b> ${currentUser}<br><b>Mascota:</b> ${m.nombre||'-'} (${m.especie||'-'}) - ${m.edad||'-'}`;
      const vHtml = data.vacunas ? Object.values(data.vacunas).map(v=>`<div class="item">游눌 <span>${v.nom}</span><span>${v.fec||''}</span></div>`).join('') : '<div style="padding:8px;color:#666">Sin vacunas</div>';
      document.getElementById('c-vacunas').innerHTML = vHtml;
      const hHtml = data.historial ? Object.values(data.historial).map(h=>`<div class="item">游뽘 <span>${h.enf}</span><span>${h.fec||''}</span></div>`).join('') : '<div style="padding:8px;color:#666">Sin historial</div>';
      document.getElementById('c-historial').innerHTML = hHtml;
      show('scr-cartilla');
    }).catch(err=> alert('Error cargando cartilla: ' + err.message));
}

/* ================== PDF (paginaci칩n por altura real) ================== */
function downloadPDF(){
  const source = document.getElementById('pdf-area');
  if (!source) { alert('No hay contenido para generar'); return; }

  const opt = {
    margin: 0,
    filename: `TIKO_${currentUser || 'user'}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true, allowTaint: false },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['css', 'legacy'] }
  };

  // 1) clonamos el 치rea
  const cloneRoot = source.cloneNode(true);

  // 2) creamos wrapper y lo a침adimos al DOM OFFSCREEN (para mediciones)
  const wrapper = document.createElement('div');
  wrapper.style.position = 'fixed';
  wrapper.style.left = '-10000px';
  wrapper.style.top = '0';
  wrapper.style.width = '210mm'; // establecer ancho A4 para medir
  wrapper.style.boxSizing = 'border-box';
  document.body.appendChild(wrapper);

  // a침adir el cloneRoot al wrapper (as칤 los elementos tienen estilos computados)
  wrapper.appendChild(cloneRoot);

  // helper para crear p치gina
  function newPage() {
    const p = document.createElement('div');
    p.className = 'pdf-page';
    const content = document.createElement('div');
    content.className = 'page-content';
    p.appendChild(content);
    wrapper.appendChild(p);
    return { page: p, content: content };
  }

  // crear la primera p치gina
  let pageObj = newPage();

  // 3) Poner encabezado (h2 y #c-mascota) en la primera p치gina
  const titleEl = cloneRoot.querySelector('h2');
  const mascotaEl = cloneRoot.querySelector('#c-mascota');
  if (titleEl) pageObj.content.appendChild(titleEl.cloneNode(true));
  if (mascotaEl) pageObj.content.appendChild(mascotaEl.cloneNode(true));

  // 4) Procesar secciones en orden para mantener encabezados (vacunas y historial)
  const sectionIds = ['c-vacunas', 'c-historial'];
  sectionIds.forEach(secId => {
    const sec = cloneRoot.querySelector('#' + secId);
    if (!sec) return;

    // obtener encabezado anterior al section (generalmente un h3)
    let header = sec.previousElementSibling && (sec.previousElementSibling.tagName || '').toLowerCase().startsWith('h') ? sec.previousElementSibling : null;

    // si hay header, cl칩nalo y a침치delo a la p치gina actual (y a p치ginas nuevas si se crean)
    const headerCloneForPage = header ? header.cloneNode(true) : null;
    if (headerCloneForPage) pageObj.content.appendChild(headerCloneForPage.cloneNode(true));

    // tomar todos los items dentro de esta secci칩n (lista est치tica)
    const items = Array.from(sec.querySelectorAll('.item'));

    for (let i = 0; i < items.length; i++) {
      const item = items[i].cloneNode(true); // clonar item (trabajamos con clones)
      pageObj.content.appendChild(item);

      // forzamos reflow y medimos overflow
      const overflow = pageObj.content.scrollHeight > pageObj.page.clientHeight;
      if (overflow) {
        // si se desborda, lo removemos y pasamos a nueva p치gina
        pageObj.content.removeChild(item);
        pageObj = newPage();
        // si hay header para la secci칩n, a침adirlo en la nueva p치gina
        if (headerCloneForPage) pageObj.content.appendChild(headerCloneForPage.cloneNode(true));
        // a침adir el item en la nueva p치gina
        pageObj.content.appendChild(item);

        // edge case: si el item por s칤 solo es m치s alto que la p치gina, lo dejamos (se desbordar치)
        // alternativa m치s avanzada: reducir fuente o dividir el item (no implementado aqu칤)
      }
    }
  });

  // 5) Generar PDF desde el wrapper (que contiene .pdf-page)
  html2pdf().set(opt).from(wrapper).toPdf().get('pdf').then(function(pdf) {
    if (window.AppInventor && typeof AppInventor.setWebViewString === 'function') {
      const dataUri = pdf.output('datauristring');
      AppInventor.setWebViewString(dataUri);
      alert('PDF enviado a la app (WebViewString). Guarda el archivo desde MIT App Inventor.');
    } else {
      pdf.save(opt.filename);
    }
  }).catch(function(err) {
    alert('Error generando PDF: ' + (err && err.message ? err.message : err));
  }).finally(function() {
    // limpieza
    wrapper.remove();
  });
}

/* ================== QR functions ================== */
/* Construye la URL de cartilla para user (usa la misma ruta actual sin query) */
function buildCartillaUrlFor(user) {
  const base = location.href.split('?')[0].split('#')[0];
  return `${base}?modo=ver&user=${encodeURIComponent(user)}`;
}

let qrcodeInstance = null;

function clearQR() {
  const container = document.getElementById('qr-container');
  container.innerHTML = '';
  document.getElementById('qr-url').textContent = '';
  qrcodeInstance = null;
}

function generateQR(url) {
  clearQR();
  const container = document.getElementById('qr-container');
  qrcodeInstance = new QRCode(container, {
    text: url,
    width: 220,
    height: 220,
    correctLevel: QRCode.CorrectLevel.H
  });
  document.getElementById('qr-url').textContent = url;
}

function generateQRForCurrentUser() {
  if (!currentUser) { alert('No hay usuario actual. Haz login o usa la opci칩n manual.'); return; }
  const url = buildCartillaUrlFor(currentUser);
  generateQR(url);
}

function generateQRManual() {
  const u = document.getElementById('qr-user-input').value.trim();
  if (!u) { alert('Escribe un usuario para generar el QR'); return; }
  const url = buildCartillaUrlFor(u.replace(/\s+/g,'_'));
  generateQR(url);
}

/* Descargar la imagen del QR */
function downloadQR() {
  const container = document.getElementById('qr-container');
  const img = container.querySelector('img');
  const canvas = container.querySelector('canvas');

  if (img) {
    const src = img.src;
    const a = document.createElement('a');
    a.href = src;
    a.download = `TIKO_QR_${Date.now()}.png`;
    a.click();
    return;
  }
  if (canvas) {
    const dataUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = `TIKO_QR_${Date.now()}.png`;
    a.click();
    return;
  }
  alert('QR no generado todav칤a');
}

/* Abrir la URL generada en nueva pesta침a */
function openQRInNewTab() {
  const url = document.getElementById('qr-url').textContent;
  if (!url) { alert('Genera primero el QR'); return; }
  window.open(url, '_blank');
}

/* =========== Exponer funciones globales =========== */
window.login = login;
window.show = show;
window.saveMascota = saveMascota;
window.addVacuna = addVacuna;
window.addHistorial = addHistorial;
window.loadList = loadList;
window.renderCartilla = renderCartilla;
window.downloadPDF = downloadPDF;
window.generateQRForCurrentUser = generateQRForCurrentUser;
window.generateQRManual = generateQRManual;
window.downloadQR = downloadQR;
window.openQRInNewTab = openQRInNewTab;
</script>
</body>
</html>

