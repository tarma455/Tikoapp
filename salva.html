<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIKO - Sistema de Salud Animal</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root { --p:#1e3a8a; --s:#2563eb; --bg:#f8fafc; }
body { font-family:Segoe UI,sans-serif; background:var(--bg); margin:0; }
.screen { display:none; padding:20px; max-width:450px; margin:auto; }
.screen.active { display:block; }
.card { background:white; padding:20px; border-radius:16px; box-shadow:0 4px 15px rgba(0,0,0,.1); }
h2 { color:var(--p); text-align:center; }
input { width:100%; padding:12px; margin:8px 0; border:1px solid #ddd; border-radius:8px; }
button { width:100%; padding:14px; border:none; border-radius:10px; background:var(--p); color:white; font-weight:bold; cursor:pointer; margin-top:10px; }
.btn-sec { background:var(--s); }
.btn-back { background:#94a3b8; }
.item { padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; font-size:14px; }
.solo-lectura .btn-back, .solo-lectura #btn-pdf-descarga { display:none!important; }
</style>
</head>

<body id="main-body">

<!-- LOGIN -->
<div id="scr-login" class="screen active">
  <h2>游 TIKO LOGIN</h2>
  <div class="card">
    <input id="login-user" placeholder="Usuario">
    <button onclick="login()">Entrar</button>
  </div>
</div>

<!-- HOME -->
<div id="scr-home" class="screen">
  <h2>Panel de Control</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <button onclick="show('scr-mascota')">游냤 Mascota</button>
    <button onclick="show('scr-vacunas')">游눌 Vacunas</button>
    <button onclick="show('scr-historial')">游뽘 Historial</button>
    <button class="btn-sec" onclick="renderCartilla()">游늶 Cartilla</button>
  </div>
  <button class="btn-back" onclick="location.reload()">Salir</button>
</div>

<!-- MASCOTA -->
<div id="scr-mascota" class="screen">
  <h2>Datos Mascota</h2>
  <div class="card">
    <input id="m-nom" placeholder="Nombre">
    <input id="m-esp" placeholder="Especie">
    <input id="m-edad" type="number" placeholder="Edad">
    <button onclick="saveMascota()">Guardar</button>
  </div>
  <button class="btn-back" onclick="show('scr-home')">Volver</button>
</div>

<!-- VACUNAS -->
<div id="scr-vacunas" class="screen">
  <h2>Vacunas</h2>
  <div class="card">
    <input id="v-nom" placeholder="Vacuna">
    <input id="v-fec" type="date">
    <button onclick="addVacuna()">A침adir</button>
    <div id="list-v"></div>
  </div>
  <button class="btn-back" onclick="show('scr-home')">Volver</button>
</div>

<!-- HISTORIAL -->
<div id="scr-historial" class="screen">
  <h2>Enfermedades</h2>
  <div class="card">
    <input id="h-enf" placeholder="Enfermedad">
    <input id="h-fec" type="date">
    <button onclick="addHistorial()">A침adir</button>
    <div id="list-h"></div>
  </div>
  <button class="btn-back" onclick="show('scr-home')">Volver</button>
</div>

<!-- CARTILLA -->
<div id="scr-cartilla" class="screen">
  <div id="pdf-area" class="card">
    <h2 style="border-bottom:3px solid var(--p)">CARTILLA TIKO</h2>
    <div id="c-mascota"></div>
    <h3>游눌 Vacunaci칩n</h3>
    <div id="c-vacunas"></div>
    <h3>游뽘 Historial</h3>
    <div id="c-historial"></div>
  </div>
  <button id="btn-pdf-descarga" class="btn-sec" onclick="downloadPDF()">游늯 Descargar PDF</button>
  <button class="btn-back" onclick="show('scr-home')">Volver</button>
</div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyANX656iqyz6NIo7WX_IvIMnY4w9SQP6sU",
  databaseURL:"https://tiko-ap-default-rtdb.firebaseio.com/",
  projectId:"tiko-ap",
  appId:"1:97455117291:web:1dc88f792d0a74c394bfae"
});
const db = firebase.database();
let currentUser = "";

/* ================= QR MODE ================= */
window.onload = () => {
  const p = new URLSearchParams(location.search);
  if(p.get("modo")==="ver" && p.get("user")){
    currentUser = p.get("user");
    document.body.classList.add("solo-lectura");
    renderCartilla();
  }
};

/* ================= FUNCIONES ================= */
function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  if(id==="scr-vacunas") loadList("vacunas","list-v");
  if(id==="scr-historial") loadList("historial","list-h");
}

function login(){
  const v = document.getElementById("login-user").value.trim();
  if(!v) return alert("Escribe un usuario");
  currentUser = v.replace(/\s+/g,"_");
  show("scr-home");
}

function saveMascota(){
  db.ref(currentUser+"/mascota").set({
    nombre:m-nom.value,
    especie:m-esp.value,
    edad:m-edad.value
  }).then(()=>alert("Guardado"));
}

function addVacuna(){
  db.ref(currentUser+"/vacunas").push({
    nom:v-nom.value,fec:v-fec.value
  }).then(()=>{v-nom.value="";loadList("vacunas","list-v")});
}

function addHistorial(){
  db.ref(currentUser+"/historial").push({
    enf:h-enf.value,fec:h-fec.value
  }).then(()=>{h-enf.value="";loadList("historial","list-h")});
}

function loadList(path,div){
  db.ref(currentUser+"/"+path).once("value",s=>{
    let h="";
    s.forEach(c=>{
      const d=c.val();
      h+=`<div class="item"><span>${d.nom||d.enf}</span><span>${d.fec}</span></div>`;
    });
    document.getElementById(div).innerHTML=h;
  });
}

function renderCartilla(){
  db.ref(currentUser).once("value",s=>{
    const d=s.val()||{};
    const m=d.mascota||{};
    c-mascota.innerHTML=`<b>Usuario:</b> ${currentUser}<br><b>Mascota:</b> ${m.nombre||"-"} (${m.especie||"-"})`;
    c-vacunas.innerHTML=d.vacunas?Object.values(d.vacunas).map(v=>`游눌 ${v.nom} - ${v.fec}`).join("<br>"):"Sin vacunas";
    c-historial.innerHTML=d.historial?Object.values(d.historial).map(h=>`游뽘 ${h.enf} - ${h.fec}`).join("<br>"):"Sin historial";
    show("scr-cartilla");
  });
}

function downloadPDF(){
  html2pdf().from(document.getElementById("pdf-area")).save(`TIKO_${currentUser}.pdf`);
}

/* ======= EXPONER A WINDOW (CLAVE) ======= */
window.login = login;
window.show = show;
window.saveMascota = saveMascota;
window.addVacuna = addVacuna;
window.addHistorial = addHistorial;
window.renderCartilla = renderCartilla;
window.downloadPDF = downloadPDF;
</script>

</body>
</html>
